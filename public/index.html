<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#000000" />

    <!-- iOS PWA basics -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Inventory Alerts" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <title>Café Bartique Inventory Alerts</title>
  </head>
  <body>
    <h1>Café Bartique Inventory Alerts</h1>
    <p>
      Click the button below on each device that should receive low-inventory
      alerts.
    </p>

    <button id="enable-btn">Enable Notifications</button>

    <pre id="log"></pre>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

    <script>
      const logEl = document.getElementById("log");
      function log(msg) {
        console.log(msg);
        logEl.textContent += msg + "\n";
      }

      const ONESIGNAL_APP_ID = "81d9cfde-7c59-4527-a003-1716bcbb2bff";

      // Safer check so we don't crash if Notification is undefined
      let permText = "Notification API not available";
      if ("Notification" in window && Notification.permission) {
        permText = Notification.permission;
      }
      log("Notification.permission (raw) = " + permText);

      window.OneSignal = window.OneSignal || [];
      OneSignal.push(function () {
        log("Initializing OneSignal…");

        OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          notifyButton: { enable: false },
        });

        log("OneSignal.init() called");

        // Is push even supported on this browser?
        if (typeof OneSignal.isPushNotificationsSupported === "function") {
          const supported = OneSignal.isPushNotificationsSupported();
          log("isPushNotificationsSupported = " + supported);
        } else {
          log(
            "isPushNotificationsSupported() not available (likely newer SDK)."
          );
        }

        // Legacy-style: log when subscription changes
        if (typeof OneSignal.on === "function") {
          OneSignal.on("subscriptionChange", function (isSubscribed) {
            log("subscriptionChange event: isSubscribed = " + isSubscribed);
          });
        } else {
          log("OneSignal.on('subscriptionChange') not available.");
        }

        // Check if already enabled
        if (typeof OneSignal.isPushNotificationsEnabled === "function") {
          OneSignal.isPushNotificationsEnabled(function (enabled) {
            log("isPushNotificationsEnabled (on load) = " + enabled);
          });
        } else {
          log("isPushNotificationsEnabled() not available.");
        }

        // Try to get a user ID (might be null until subscribed)
        if (typeof OneSignal.getUserId === "function") {
          OneSignal.getUserId(function (userId) {
            log("getUserId() = " + userId);
          });
        } else {
          log("getUserId() not available on this SDK version.");
        }
      });

      document
        .getElementById("enable-btn")
        .addEventListener("click", function () {
          log("Enable Notifications button clicked.");

          OneSignal.push(async function () {
            try {
              // For older SDK (player model)
              if (
                typeof OneSignal.registerForPushNotifications === "function"
              ) {
                log("Calling OneSignal.registerForPushNotifications()…");
                await OneSignal.registerForPushNotifications();
              } else if (
                OneSignal.Notifications &&
                typeof OneSignal.Notifications.requestPermission === "function"
              ) {
                // For newer SDK (user model)
                log("Calling OneSignal.Notifications.requestPermission()…");
                await OneSignal.Notifications.requestPermission();
              } else {
                log("No known permission API on this OneSignal SDK.");
              }

              // Check status again after prompt
              if (typeof OneSignal.isPushNotificationsEnabled === "function") {
                OneSignal.isPushNotificationsEnabled(function (enabled) {
                  log("isPushNotificationsEnabled (after click) = " + enabled);
                });
              }

              if (typeof OneSignal.getUserId === "function") {
                OneSignal.getUserId(function (userId) {
                  log("getUserId() (after click) = " + userId);
                });
              }
            } catch (e) {
              log("Error while requesting permission: " + e.message);
            }
          });
        });
    </script>

    <!-- <script>
      const logEl = document.getElementById("log");
      function log(msg) {
        console.log(msg);
        logEl.textContent += msg + "\n";
      }

      // Replace this with your real app ID
      const ONESIGNAL_APP_ID = "81d9cfde-7c59-4527-a003-1716bcbb2bff"; // <-- your App ID here

      window.OneSignal = window.OneSignal || [];
      OneSignal.push(function () {
        log("Initializing OneSignal…");

        OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          notifyButton: { enable: false },
        });

        log("OneSignal.init() called");
      });

      // Show current permission on load
      log("Notification.permission = " + Notification.permission);

      document
        .getElementById("enable-btn")
        .addEventListener("click", function () {
          log("Enable Notifications button clicked.");

          OneSignal.push(async function () {
            try {
              const state = await OneSignal.getNotificationPermission();
              log("OneSignal permission state before request: " + state);

              if (state === "default") {
                log(
                  "Requesting permission via OneSignal.registerForPushNotifications()"
                );
                await OneSignal.registerForPushNotifications();
              } else {
                log("Permission already " + state);
              }

              const after = await OneSignal.getNotificationPermission();
              log("OneSignal permission state after request: " + after);
            } catch (e) {
              log("Error while requesting permission: " + e.message);
            }
          });
        });
    </script> -->
  </body>
</html>
